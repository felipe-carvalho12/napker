{"ast":null,"code":"import _toConsumableArray from\"C:\\\\Users\\\\felip\\\\CodeProjects\\\\Web\\\\Napker\\\\frontend\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";import _classCallCheck from\"C:\\\\Users\\\\felip\\\\CodeProjects\\\\Web\\\\Napker\\\\frontend\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\felip\\\\CodeProjects\\\\Web\\\\Napker\\\\frontend\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import _inherits from\"C:\\\\Users\\\\felip\\\\CodeProjects\\\\Web\\\\Napker\\\\frontend\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";import _createSuper from\"C:\\\\Users\\\\felip\\\\CodeProjects\\\\Web\\\\Napker\\\\frontend\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createSuper\";import React from'react';import{Link}from'react-router-dom';import{csrftoken,updateUnreadMessagesNumber}from'../../../../config/utils';import{SERVER_URL}from'../../../../config/settings';import WebSocketInstance from'../../Websocket';import SendMessageForm from'./components/SendMessageForm';import MessageListItem from'./components/MessageListItem';var Chat=/*#__PURE__*/function(_React$Component){_inherits(Chat,_React$Component);var _super=_createSuper(Chat);_createClass(Chat,[{key:\"initialiseChat\",value:function initialiseChat(){var _this2=this;console.log('initializing chat...');this.waitForSocketConnection(function(){WebSocketInstance.addCallbacks(_this2.getMessages.bind(_this2),_this2.addMessage.bind(_this2));WebSocketInstance.fetchMessages(_this2.props.username,_this2.props.chatId);});if(this.props.chatId)WebSocketInstance.connect(this.props.chatId);}}]);function Chat(_props){var _this;_classCallCheck(this,Chat);_this=_super.call(this,_props);_this.handleComponentChange=function(){if(_this.state.otherUsername&&(!_this.state.otherProfile||_this.state.otherProfile.user.username!==_this.state.otherUsername)){fetch(\"\".concat(SERVER_URL,\"/profile-api/user/\").concat(_this.state.otherUsername)).then(function(response){return response.json();}).then(function(data){return _this.setState({otherProfile:data});});}if(!_this.state.myProfile){fetch(\"\".concat(SERVER_URL,\"/profile-api/myprofile\")).then(function(response){return response.json();}).then(function(data){return _this.setState({myProfile:data});});}if(_this.state.messages.length&&!_this.state.scrolledToBottom&&document.querySelectorAll('.sent, .received').length){_this.scrollToBottom();}};_this.readMessages=function(props){fetch(\"\".concat(SERVER_URL,\"/chat-api/read-messages\"),{method:'POST',headers:{'Content-type':'application/json','X-CSRFToken':csrftoken},body:JSON.stringify({chat_id:props.chatId})}).then(function(response){return response.json();}).then(function(data){console.log(data);WebSocketInstance.readMessages(_this.props.chatId);});};_this.scrollToBottom=function(){if(document.querySelector('#chat-log')){var chatLog=document.querySelector('#chat-log');chatLog.scrollTop=chatLog.scrollHeight;_this.setState({scrolledToBottom:true});}};_this.state={messages:[],scrolledToBottom:false,myProfile:null,otherUsername:_this.props.otherUsername,otherProfile:null};_this.initialiseChat();return _this;}_createClass(Chat,[{key:\"componentDidMount\",value:function componentDidMount(){this.handleComponentChange();}},{key:\"componentDidUpdate\",value:function componentDidUpdate(){this.handleComponentChange();document.querySelector('#contact-filter-input')&&document.activeElement!==document.querySelector('#contact-filter-input')&&document.querySelector('#chat-message-input')&&document.querySelector('#chat-message-input').focus();}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){WebSocketInstance.disconnect();}},{key:\"componentWillReceiveProps\",value:function componentWillReceiveProps(newProps){if(newProps.chatId&&newProps.chatId!==this.props.chatId&&newProps.otherUsername&&WebSocketInstance.state()!==1){this.waitForSocketConnection(function(){WebSocketInstance.fetchMessages(newProps.username,newProps.chatId);});WebSocketInstance.connect(newProps.chatId);this.readMessages(newProps);this.props.updateMessagesComponent();this.setState({messages:[],scrolledToBottom:false});}if(this.state.otherUsername!==newProps.otherUsername){this.setState({otherUsername:newProps.otherUsername});}if(newProps.otherUsername){updateUnreadMessagesNumber();}if(this.state.otherUsername&&!newProps.otherUsername){WebSocketInstance.disconnect();this.setState({otherUsername:undefined,otherProfile:undefined});}}},{key:\"waitForSocketConnection\",value:function waitForSocketConnection(callback){var component=this;setTimeout(function(){if(WebSocketInstance.state()===1){console.log(\"Connection is made\");callback();return;}else{console.log(\"wait for connection...\");component.waitForSocketConnection(callback);}},100);}},{key:\"getMessages\",value:function getMessages(messages){this.setState({messages:messages.reverse()});}},{key:\"addMessage\",value:function addMessage(message){this.setState({messages:[].concat(_toConsumableArray(this.state.messages),[message]),scrolledToBottom:false});this.readMessages(this.props);}},{key:\"render\",value:function render(){var _this3=this;return/*#__PURE__*/React.createElement(React.Fragment,null,this.state.otherProfile!==null||!this.props.otherUsername?/*#__PURE__*/React.createElement(React.Fragment,null,this.state.otherProfile?/*#__PURE__*/React.createElement(\"div\",{className:\"current-chat\"},/*#__PURE__*/React.createElement(\"div\",{className:\"current-chat-header\"},/*#__PURE__*/React.createElement(\"i\",{class:\"fas fa-arrow-left left-arrow-icon\",onClick:function onClick(){return window.history.back();}}),/*#__PURE__*/React.createElement(Link,{to:\"/user/\".concat(this.state.otherProfile.slug)},/*#__PURE__*/React.createElement(\"img\",{src:\"\".concat(SERVER_URL).concat(this.state.otherProfile.photo),className:\"profile-img-sm\",style:{marginRight:'5px'}})),/*#__PURE__*/React.createElement(\"div\",{className:\"d-flex flex-column align-items-start\",style:{height:'52px'}},/*#__PURE__*/React.createElement(\"strong\",null,this.state.otherProfile.first_name,\" \",this.state.otherProfile.last_name),/*#__PURE__*/React.createElement(\"p\",{className:\"text-secondary\"},\"@\",this.state.otherProfile.user.username))),/*#__PURE__*/React.createElement(\"div\",{id:\"chat-log\"},this.state.messages.map(function(message){return/*#__PURE__*/React.createElement(MessageListItem,{message:message,currentUser:_this3.props.username});})),/*#__PURE__*/React.createElement(SendMessageForm,{WebSocketInstance:WebSocketInstance,chatId:this.props.chatId,username:this.props.username,otherProfile:this.state.otherProfile,myProfile:this.state.myProfile,updateMessagesComponent:this.props.updateMessagesComponent})):/*#__PURE__*/React.createElement(\"div\",{className:\"current-chat no-chat-selected\"},/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"strong\",{style:{fontSize:'larger'}},\"Voc\\xEA n\\xE3o tem uma conversa selecionada\"),/*#__PURE__*/React.createElement(\"p\",{className:\"text-secondary\"},\"Selecione uma existente ou comece uma nova\"),/*#__PURE__*/React.createElement(\"button\",{className:\"btn btn-primary\",onClick:function onClick(){return _this3.props.openModal();}},\"Nova conversa\")))):/*#__PURE__*/React.createElement(\"div\",{className:\"chat-loader-container\"},/*#__PURE__*/React.createElement(\"div\",{className:\"loader\"})));}}]);return Chat;}(React.Component);export default Chat;","map":{"version":3,"sources":["C:/Users/felip/CodeProjects/Web/Napker/frontend/src/pages/messages_/components/chat_/Chat.js"],"names":["React","Link","csrftoken","updateUnreadMessagesNumber","SERVER_URL","WebSocketInstance","SendMessageForm","MessageListItem","Chat","console","log","waitForSocketConnection","addCallbacks","getMessages","bind","addMessage","fetchMessages","props","username","chatId","connect","handleComponentChange","state","otherUsername","otherProfile","user","fetch","then","response","json","data","setState","myProfile","messages","length","scrolledToBottom","document","querySelectorAll","scrollToBottom","readMessages","method","headers","body","JSON","stringify","chat_id","querySelector","chatLog","scrollTop","scrollHeight","initialiseChat","activeElement","focus","disconnect","newProps","updateMessagesComponent","undefined","callback","component","setTimeout","reverse","message","window","history","back","slug","photo","marginRight","height","first_name","last_name","map","fontSize","openModal","Component"],"mappings":"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","sourcesContent":["import React from 'react'\r\nimport { Link } from 'react-router-dom'\r\n\r\nimport { csrftoken, updateUnreadMessagesNumber } from '../../../../config/utils'\r\nimport { SERVER_URL } from '../../../../config/settings'\r\nimport WebSocketInstance from '../../Websocket'\r\nimport SendMessageForm from './components/SendMessageForm'\r\nimport MessageListItem from './components/MessageListItem'\r\n\r\nclass Chat extends React.Component {\r\n    initialiseChat() {\r\n        console.log('initializing chat...')\r\n        this.waitForSocketConnection(() => {\r\n            WebSocketInstance.addCallbacks(\r\n                this.getMessages.bind(this),\r\n                this.addMessage.bind(this),\r\n            )\r\n            WebSocketInstance.fetchMessages(\r\n                this.props.username,\r\n                this.props.chatId\r\n            );\r\n        });\r\n        if (this.props.chatId) WebSocketInstance.connect(this.props.chatId)\r\n    }\r\n\r\n    constructor(props) {\r\n        super(props);\r\n        this.state = {\r\n            messages: [],\r\n            scrolledToBottom: false,\r\n            myProfile: null,\r\n            otherUsername: this.props.otherUsername,\r\n            otherProfile: null\r\n        }\r\n        this.initialiseChat();\r\n    }\r\n\r\n    handleComponentChange = () => {\r\n        if (this.state.otherUsername && (!this.state.otherProfile || this.state.otherProfile.user.username !== this.state.otherUsername)) {\r\n            fetch(`${SERVER_URL}/profile-api/user/${this.state.otherUsername}`)\r\n                .then(response => response.json())\r\n                .then(data => this.setState({\r\n                    otherProfile: data\r\n                }))\r\n        }\r\n        if (!this.state.myProfile) {\r\n            fetch(`${SERVER_URL}/profile-api/myprofile`)\r\n                .then(response => response.json())\r\n                .then(data => this.setState({ myProfile: data }))\r\n        }\r\n        if (this.state.messages.length && !this.state.scrolledToBottom && document.querySelectorAll('.sent, .received').length) {\r\n            this.scrollToBottom()\r\n        }\r\n    }\r\n\r\n    componentDidMount() {\r\n        this.handleComponentChange()\r\n    }\r\n\r\n\r\n    componentDidUpdate() {\r\n        this.handleComponentChange()\r\n        document.querySelector('#contact-filter-input') &&\r\n            document.activeElement !== document.querySelector('#contact-filter-input') &&\r\n            document.querySelector('#chat-message-input') &&\r\n            document.querySelector('#chat-message-input').focus()\r\n    }\r\n\r\n    componentWillUnmount() {\r\n        WebSocketInstance.disconnect()\r\n    }\r\n\r\n    componentWillReceiveProps(newProps) {\r\n        if (newProps.chatId && newProps.chatId !== this.props.chatId && newProps.otherUsername && WebSocketInstance.state() !== 1) {\r\n            this.waitForSocketConnection(() => {\r\n                WebSocketInstance.fetchMessages(\r\n                    newProps.username,\r\n                    newProps.chatId\r\n                );\r\n            });\r\n            WebSocketInstance.connect(newProps.chatId)\r\n            this.readMessages(newProps)\r\n\r\n            this.props.updateMessagesComponent()\r\n            this.setState({\r\n                messages: [],\r\n                scrolledToBottom: false,\r\n            })\r\n        }\r\n        if (this.state.otherUsername !== newProps.otherUsername) {\r\n            this.setState({\r\n                otherUsername: newProps.otherUsername\r\n            })\r\n        }\r\n        if (newProps.otherUsername) {\r\n            updateUnreadMessagesNumber()\r\n        }\r\n        if (this.state.otherUsername && !newProps.otherUsername) {\r\n            WebSocketInstance.disconnect()\r\n            this.setState({\r\n                otherUsername: undefined,\r\n                otherProfile: undefined\r\n            })\r\n        }\r\n    }\r\n\r\n    readMessages = props => {\r\n        fetch(`${SERVER_URL}/chat-api/read-messages`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-type': 'application/json',\r\n                'X-CSRFToken': csrftoken,\r\n            },\r\n            body: JSON.stringify({ chat_id: props.chatId })\r\n        })\r\n            .then(response => response.json())\r\n            .then(data => {\r\n                console.log(data)\r\n                WebSocketInstance.readMessages(this.props.chatId)\r\n            })\r\n    }\r\n\r\n    waitForSocketConnection(callback) {\r\n        const component = this;\r\n        setTimeout(function () {\r\n            if (WebSocketInstance.state() === 1) {\r\n                console.log(\"Connection is made\");\r\n                callback();\r\n                return;\r\n            } else {\r\n                console.log(\"wait for connection...\");\r\n                component.waitForSocketConnection(callback);\r\n            }\r\n        }, 100);\r\n    }\r\n\r\n    getMessages(messages) {\r\n        this.setState({ messages: messages.reverse() })\r\n    }\r\n\r\n    addMessage(message) {\r\n        this.setState({\r\n            messages: [...this.state.messages, message],\r\n            scrolledToBottom: false\r\n        })\r\n        this.readMessages(this.props)\r\n    }\r\n\r\n    scrollToBottom = () => {\r\n        if (document.querySelector('#chat-log')) {\r\n            const chatLog = document.querySelector('#chat-log')\r\n            chatLog.scrollTop = chatLog.scrollHeight\r\n            this.setState({\r\n                scrolledToBottom: true\r\n            })\r\n        }\r\n    };\r\n\r\n    render() {\r\n        return (\r\n            <>\r\n                {this.state.otherProfile !== null || !this.props.otherUsername ?\r\n                    <>\r\n                        {this.state.otherProfile ?\r\n                            <div className=\"current-chat\">\r\n                                <div className=\"current-chat-header\">\r\n                                    <i class=\"fas fa-arrow-left left-arrow-icon\" onClick={() => window.history.back()} />\r\n                                    <Link to={`/user/${this.state.otherProfile.slug}`}>\r\n                                        <img src={`${SERVER_URL}${this.state.otherProfile.photo}`}\r\n                                            className=\"profile-img-sm\"\r\n                                            style={{ marginRight: '5px' }}\r\n                                        />\r\n                                    </Link>\r\n                                    <div className=\"d-flex flex-column align-items-start\" style={{ height: '52px' }}>\r\n                                        <strong>{this.state.otherProfile.first_name} {this.state.otherProfile.last_name}</strong>\r\n                                        <p className=\"text-secondary\">@{this.state.otherProfile.user.username}</p>\r\n                                    </div>\r\n                                </div>\r\n                                <div id=\"chat-log\">\r\n                                    {this.state.messages.map(message => {\r\n                                        return (\r\n                                            <MessageListItem message={message} currentUser={this.props.username} />\r\n                                        )\r\n                                    })\r\n                                    }\r\n                                </div>\r\n                                <SendMessageForm\r\n                                    WebSocketInstance={WebSocketInstance}\r\n                                    chatId={this.props.chatId}\r\n                                    username={this.props.username}\r\n                                    otherProfile={this.state.otherProfile}\r\n                                    myProfile={this.state.myProfile}\r\n                                    updateMessagesComponent={this.props.updateMessagesComponent}\r\n                                />\r\n                            </div>\r\n                            :\r\n                            <div className=\"current-chat no-chat-selected\">\r\n                                <div>\r\n                                    <strong style={{ fontSize: 'larger' }}>Você não tem uma conversa selecionada</strong>\r\n                                    <p className=\"text-secondary\">Selecione uma existente ou comece uma nova</p>\r\n                                    <button className=\"btn btn-primary\" onClick={() => this.props.openModal()}>Nova conversa</button>\r\n                                </div>\r\n                            </div>\r\n                        }\r\n                    </>\r\n                    :\r\n                    <div className=\"chat-loader-container\">\r\n                        <div className=\"loader\" />\r\n                    </div>\r\n                }\r\n            </>\r\n        )\r\n    }\r\n}\r\n\r\nexport default Chat\r\n"]},"metadata":{},"sourceType":"module"}